<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recrutement - Faction R4TIO</title>
    <link rel="icon" href="../images/pictures/Logo.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .recrutement-container { max-width: 900px; margin: 40px auto; padding: 40px; background-color: var(--card-bg-color); border-radius: 10px; border: 1px solid #444; }
        .recrutement-container h1 { font-family: var(--font-display); font-size: 3.5rem; color: var(--primary-red); text-align: center; margin-bottom: 30px; text-transform: uppercase; }
        .recrutement-section { margin-bottom: 40px; }
        .recrutement-section h2 { color: var(--text-light); border-bottom: 2px solid var(--primary-red); padding-bottom: 10px; margin-bottom: 20px; font-size: 2rem; }
        .recrutement-section ul { list-style-type: none; padding-left: 0; }
        .recrutement-section ul li { background-color: rgba(255, 255, 255, 0.05); margin-bottom: 10px; padding: 15px; border-radius: 5px; border-left: 4px solid var(--primary-red); color: var(--text-medium); font-size: 1.1rem; }
        .recrutement-section p { color: var(--text-medium); line-height: 1.7; font-size: 1.1rem; }
        .recrutement-actions { text-align: center; margin-top: 40px; }
        .btn-action { background-color: var(--primary-red); color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; font-weight: 700; font-size: 1.2rem; text-transform: uppercase; transition: background-color 0.3s ease; border: none; cursor: pointer; }
        .btn-action:hover { background-color: var(--primary-red-dark); }
        .form-container { background-color: var(--card-bg-color); padding: 2rem; border-radius: 10px; border: 1px solid #444; }
        .form-section h2 { font-family: 'Anton', sans-serif; font-size: 1.8rem; color: var(--primary-red); border-bottom: 2px solid var(--primary-red); padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; color: var(--text-medium); font-weight: bold; margin-bottom: 0.5rem; }
        .form-group input, .form-group textarea { width: 100%; padding: 0.75rem 1rem; border-radius: 5px; background-color: #333; color: var(--text-light); border: 2px solid #555; box-sizing: border-box; transition: border-color 0.3s; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-red); }
        .submit-btn { width: 100%; background-color: var(--primary-red); color: white; font-weight: bold; padding: 1rem; border: none; border-radius: 5px; cursor: pointer; text-transform: uppercase; transition: background-color 0.3s; font-size: 1.2rem; }
        .submit-btn:hover:not(:disabled) { background-color: var(--primary-red-dark); }
        .submit-btn:disabled { background-color: #555; cursor: not-allowed; }
        .status-box { background-color: var(--card-bg-color); padding: 3rem; border-radius: 10px; border: 1px solid #444; text-align: center; }
        .status-box i { font-size: 4rem; margin-bottom: 1rem; }
        .status-box .fa-clock { color: var(--yellow); }
        .status-box .fa-check-circle { color: var(--green); }
        .status-box .fa-times-circle { color: var(--primary-red); }
        .status-box h2 { font-family: 'Anton', sans-serif; font-size: 2.5rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .recruiter-section { margin-bottom: 2.5rem; }
        .recruiter-section h2 { font-family: 'Anton', sans-serif; font-size: 2rem; color: var(--text-medium); border-bottom: 2px solid #555; padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
        .application-card { background-color: var(--card-bg-color); border-radius: 10px; border-left: 5px solid #555; margin-bottom: 1rem; transition: all 0.3s ease; }
        .application-card.approved { border-left-color: var(--green); }
        .application-card.denied { border-left-color: var(--primary-red); }
        .application-header { display: flex; align-items: center; padding: 1rem 1.5rem; cursor: pointer; }
        .applicant-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 1rem; }
        .applicant-info h3 { font-size: 1.5rem; color: var(--text-light); margin: 0; }
        .applicant-info span { font-size: 0.9rem; color: var(--text-medium); }
        .expand-icon { margin-left: auto; transition: transform 0.3s ease; }
        .application-card.open .expand-icon { transform: rotate(180deg); }
        .application-body { max-height: 0; overflow: hidden; transition: max-height 0.5s ease, padding 0.5s ease; padding: 0 1.5rem; }
        .application-card.open .application-body { max-height: 1500px; padding: 1rem 1.5rem 1.5rem; }
        .application-body p { margin: 0 0 1rem 0; line-height: 1.6; word-wrap: break-word; }
        .application-body strong { color: var(--text-light); }
        .details-divider { border-color: #444; margin: 1rem 0;}
        .application-actions { display: flex; gap: 1rem; margin-top: 1.5rem; border-top: 1px solid #444; padding-top: 1.5rem; }
        .action-btn { flex-grow: 1; color: white; font-weight: bold; padding: 0.7rem 1rem; border: none; border-radius: 5px; cursor: pointer; text-transform: uppercase; transition: opacity 0.3s; }
        .action-btn:hover:not(:disabled) { opacity: 0.8; }
        .approve-btn { background-color: var(--green); }
        .deny-btn { background-color: var(--primary-red); }
        .nav-auth { display: flex; align-items: center; gap: 25px; }
        .nav-admin-links { display: flex; gap: 20px; }
        .nav-admin-links a { color: var(--yellow); font-weight: 700; text-transform: uppercase; }
        .nav-toggle { display: none; background: none; border: none; cursor: pointer; padding: 10px; }
        .nav-toggle .hamburger { display: block; width: 25px; height: 3px; background-color: var(--text-light); position: relative; transition: transform 0.3s ease; }
        .nav-toggle .hamburger::before, .nav-toggle .hamburger::after { content: ''; position: absolute; left: 0; width: 100%; height: 3px; background-color: var(--text-light); transition: transform 0.3s ease, top 0.3s ease, bottom 0.3s ease; }
        .nav-toggle .hamburger::before { top: -8px; }
        .nav-toggle .hamburger::after { bottom: -8px; }
        @media (max-width: 991px) {
            .navbar { flex-wrap: wrap; justify-content: space-between; }
            .nav-toggle { display: block; }
            .nav-center, .nav-auth { display: none; flex-direction: column; width: 100%; text-align: center; gap: 15px; padding: 20px 0; }
            .nav-auth { gap: 20px; }
            .navbar.active .nav-center, .navbar.active .nav-auth { display: flex; }
            .nav-admin-links { justify-content: center; }
            #auth-buttons { display: flex; flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-left"><a href="../index.html"><img src="../images/pictures/Logo.png" alt="Logo R4TIO" class="nav-logo"></a></div>
        <button class="nav-toggle" id="nav-toggle"><span class="hamburger"></span></button>
        <div class="nav-center">
            <a href="https://discord.gg/UFVCDc4mkU" target="_blank" rel="noopener noreferrer">Discord</a>
            <a href="recrutement.html">Recrutement</a>
            <a href="market.html">Marché</a>
        </div>
        <div class="nav-auth">
            <div class="nav-admin-links">
                <a href="orders.html" id="orders-link" style="display: none;">Commandes</a>
                <a href="admin.html" id="admin-link" style="display: none;">Administration</a>
            </div>
            <div id="auth-buttons"><a href="login.html">Connexion</a><a href="register.html" class="register-btn">Inscription</a></div>
            <a href="profile.html" id="profile-link" style="display: none;"><img id="profile-pic" src="" alt="Photo de profil"></a>
        </div>
    </nav>

    <div class="page-container">
        <div id="recruitment-info-view">
             <div class="recrutement-container">
                <h1>Rejoindre R4TIO</h1>
                <div class="recrutement-section">
                    <h2>Nos Critères</h2>
                    <ul>
                        <li>Avoir une expérience significative sur les serveurs faction.</li>
                        <li>Maîtriser les bases du PvP et des pillages.</li>
                        <li>Être actif et disponible pour les événements de la faction.</li>
                        <li>Faire preuve de maturité et de respect envers les autres membres.</li>
                        <li>Posséder un microphone fonctionnel et être présent sur Discord.</li>
                    </ul>
                </div>
                <div class="recrutement-section">
                    <h2>Le Processus</h2>
                    <p>Si vous pensez avoir le profil, la première étape est de remplir le formulaire de candidature. S'il est convaincant, vous passerez ensuite un entretien oral avec un de nos recruteurs sur Discord.</p>
                </div>
                <div class="recrutement-actions">
                    <button id="show-form-btn" class="btn-action">Remplir le formulaire</button>
                </div>
            </div>
        </div>

        <div id="applicant-view" class="d-none">
            <div class="page-header"><h1>Devenir un membre R4TIO</h1><p>Prouve-nous que tu as ce qu'il faut pour rejoindre l'élite. Remplis ce formulaire avec soin.</p></div>
            <form id="recruitment-form" class="form-container">
                <div class="form-section">
                    <h2>Informations personnelles</h2>
                    <div class="form-group"><label for="age">Âge</label><input type="number" id="age" required></div>
                    <div class="form-group"><label for="qualities">3 Qualités</label><input type="text" id="qualities" placeholder="Ex: Stratège, Calme, Organisé" required></div>
                    <div class="form-group"><label for="defects">3 Défauts</label><input type="text" id="defects" placeholder="Ex: Bavard, Impatient, Têtu" required></div>
                </div>
                <div class="form-section">
                    <h2>Informations en jeu</h2>
                    <div class="form-group"><label for="pseudo">Pseudo</label><input type="text" id="pseudo" required></div>
                    <div class="form-group"><label for="version">Depuis quelle version jouez-vous ?</label><input type="text" id="version" placeholder="Ex: V6, V7..." required></div>
                    <div class="form-group"><label for="knowledge">Connaissez-vous bien le serveur ?</label><textarea id="knowledge" required></textarea></div>
                    <div class="form-group"><label for="speciality">Quelle est votre spécialité ?</label><input type="text" id="speciality" placeholder="Ex: PvP, Build, Farm..." required></div>
                </div>
                <div class="form-section">
                    <h2>Informations de Faction</h2>
                    <div class="form-group"><label for="why-you">Pourquoi vous et pas un autre ?</label><textarea id="why-you" required></textarea></div>
                    <div class="form-group"><label for="why-us">Pourquoi notre faction ?</label><textarea id="why-us" required></textarea></div>
                    <div class="form-group"><label for="past-factions">Avez-vous déjà été dans d’autres factions ? Si oui, lesquelles ?</label><textarea id="past-factions" required></textarea></div>
                </div>
                <button type="submit" class="submit-btn" id="submit-application-btn">Soumettre ma candidature</button>
            </form>
        </div>
        <div id="pending-view" class="d-none"><div class="status-box"><i class="fas fa-clock"></i><h2>Candidature envoyée !</h2><p>Merci pour ton intérêt ! Ta candidature est en cours d'examen par notre staff. Nous te contacterons si ton profil est retenu.</p></div></div>
        <div id="approved-view" class="d-none"><div class="status-box"><i class="fas fa-check-circle"></i><h2>Candidature Approuvée !</h2><p>Félicitations ! Ta candidature a été acceptée. Tu es maintenant un membre de R4TIO. Bienvenue !</p></div></div>
        <div id="denied-view" class="d-none"><div class="status-box"><i class="fas fa-times-circle"></i><h2>Candidature Refusée</h2><p>Nous te remercions pour l'intérêt que tu portes à notre faction. Malheureusement, nous avons décidé de ne pas donner suite à ta candidature pour le moment.</p></div></div>
        <div id="recruiter-view" class="d-none">
            <div class="page-header"><h1>Gestion des Candidatures</h1><p>Examinez les candidatures et prenez votre décision.</p></div>
            <div class="recruiter-section"><h2>En attente (<span id="pending-count">0</span>)</h2><div id="pending-list"><p>Chargement...</p></div></div>
            <div class="recruiter-section"><h2>Approuvées (<span id="approved-count">0</span>)</h2><div id="approved-list"></div></div>
            <div class="recruiter-section"><h2>Refusées (<span id="denied-count">0</span>)</h2><div id="denied-list"></div></div>
        </div>
    </div>
    <div id="message-box"></div>
    <script type="module" src="../js/main.js"></script>
    <script type="module">
        import { auth, db } from '../js/firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, getDoc, setDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const ROLES = { RECRUITER: 'Recruteur', LEADER: 'Leader', MEMBER: 'Membre', CANDIDATE: 'Candidat', VISITOR: 'Visiteur', ADMIN: 'Admin', OFFICIER: 'Officier' };
        const APP_STATUS = { PENDING: 'en attente', APPROVED: 'approuvée', DENIED: 'refusée' };
        
        const views = { 
            info: document.getElementById('recruitment-info-view'),
            applicant: document.getElementById('applicant-view'), 
            pending: document.getElementById('pending-view'), 
            approved: document.getElementById('approved-view'), 
            denied: document.getElementById('denied-view'), 
            recruiter: document.getElementById('recruiter-view') 
        };
        const lists = { pending: document.getElementById('pending-list'), approved: document.getElementById('approved-list'), denied: document.getElementById('denied-list') };
        const counts = { pending: document.getElementById('pending-count'), approved: document.getElementById('approved-count'), denied: document.getElementById('denied-count') };
        const recruitmentForm = document.getElementById('recruitment-form');
        const showFormBtn = document.getElementById('show-form-btn');
        const navToggle = document.getElementById('nav-toggle');
        const navbar = document.querySelector('.navbar');
        
        let currentUserData = null;

        navToggle.addEventListener('click', () => navbar.classList.toggle('active'));
        
        if (showFormBtn) {
            showFormBtn.addEventListener('click', () => {
                if (auth.currentUser) {
                    showView('applicant');
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userDocRef = doc(db, 'users', user.uid);
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists() && docSnap.data().onboardingComplete) {
                        currentUserData = { id: user.uid, ...docSnap.data() };
                        await showCorrectView();
                    } else { window.location.href = 'onboarding.html'; }
                } catch (error) { console.error("Erreur de chargement des données utilisateur:", error); }
            } else {
                showView('info');
            }
        });

        function showView(viewName) {
            Object.values(views).forEach(v => v.classList.add('d-none'));
            if (views[viewName]) views[viewName].classList.remove('d-none');
        }

        async function showCorrectView() {
            const userRole = currentUserData.role;
            const isRecruitmentStaff = [ROLES.ADMIN, ROLES.LEADER, ROLES.OFFICIER, ROLES.RECRUITER].includes(userRole);
            
            if (isRecruitmentStaff) {
                showView('recruiter');
                await loadAllApplications();
                return;
            }

            const appDocRef = doc(db, 'candidatures', currentUserData.id);
            const appDocSnap = await getDoc(appDocRef);

            if (appDocSnap.exists()) {
                const appStatus = appDocSnap.data().status;
                if (appStatus === APP_STATUS.APPROVED) showView('approved');
                else if (appStatus === APP_STATUS.DENIED) showView('denied');
                else showView('pending');
            } else {
                showView('info');
                if(recruitmentForm) { recruitmentForm.querySelector('#pseudo').value = currentUserData.minecraftUsername || ''; }
            }
        }

        if(recruitmentForm) {
            recruitmentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Envoi...`;
                
                const applicationData = {
                    userId: currentUserData.id, applicantUsername: currentUserData.minecraftUsername, applicantAvatar: currentUserData.avatar,
                    age: recruitmentForm.querySelector('#age').value, qualities: recruitmentForm.querySelector('#qualities').value, defects: recruitmentForm.querySelector('#defects').value,
                    pseudo: recruitmentForm.querySelector('#pseudo').value, version: recruitmentForm.querySelector('#version').value, knowledge: recruitmentForm.querySelector('#knowledge').value,
                    speciality: recruitmentForm.querySelector('#speciality').value, whyYou: recruitmentForm.querySelector('#why-you').value, whyUs: recruitmentForm.querySelector('#why-us').value,
                    pastFactions: recruitmentForm.querySelector('#past-factions').value, status: APP_STATUS.PENDING, submittedAt: new Date().toISOString()
                };

                try {
                    await setDoc(doc(db, 'candidatures', currentUserData.id), applicationData);
                    await updateDoc(doc(db, 'users', currentUserData.id), { role: ROLES.CANDIDATE });
                    showView('pending');
                } catch (error) {
                    console.error("Erreur lors de la soumission :", error);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Soumettre ma candidature';
                }
            });
        }

        async function loadAllApplications() {
            Object.values(lists).forEach(list => list.innerHTML = '');
            let pendingCount = 0, approvedCount = 0, deniedCount = 0;
            try {
                const querySnapshot = await getDocs(collection(db, "candidatures"));
                if (querySnapshot.empty) {
                    lists.pending.innerHTML = '<p>Aucune nouvelle candidature.</p>';
                } else {
                    querySnapshot.docs.forEach(appDoc => {
                        const appData = appDoc.data();
                        const card = createApplicationCard(appData);
                        if (appData.status === APP_STATUS.APPROVED) { lists.approved.appendChild(card); approvedCount++; }
                        else if (appData.status === APP_STATUS.DENIED) { lists.denied.appendChild(card); deniedCount++; }
                        else { lists.pending.appendChild(card); pendingCount++; }
                    });
                }
            } catch (error) {
                console.error("Erreur de chargement des candidatures:", error);
                lists.pending.innerHTML = '<p>Erreur de chargement.</p>';
            }
            counts.pending.textContent = pendingCount;
            counts.approved.textContent = approvedCount;
            counts.denied.textContent = deniedCount;
        }

        function createApplicationCard(app) {
            const card = document.createElement('div');
            card.className = 'application-card';
            if(app.status === APP_STATUS.APPROVED) card.classList.add('approved');
            if(app.status === APP_STATUS.DENIED) card.classList.add('denied');
            const avatar = app.applicantAvatar || `https://corsproxy.io/?https://mc-heads.net/avatar/${app.applicantUsername || 'Steve'}/40`;
            const submittedDate = new Date(app.submittedAt).toLocaleDateString('fr-FR');
            card.innerHTML = `
                <div class="application-header">
                    <img src="${avatar}" alt="avatar" class="applicant-avatar" onerror="this.src='https://corsproxy.io/?https://mc-heads.net/avatar/Steve/40'">
                    <div class="applicant-info"><h3>${app.applicantUsername || 'N/A'}</h3><span>Candidature du ${submittedDate}</span></div>
                    <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="application-body">
                    <p><strong>Âge :</strong> ${app.age || 'N/A'}</p><p><strong>Qualités :</strong> ${app.qualities || 'N/A'}</p><p><strong>Défauts :</strong> ${app.defects || 'N/A'}</p>
                    <hr class="details-divider">
                    <p><strong>Spécialité(s) :</strong> ${app.speciality || 'N/A'}</p><p><strong>Anciennes factions :</strong> ${app.pastFactions || 'N/A'}</p>
                    <hr class="details-divider">
                    <p><strong>Pourquoi lui ?</strong> ${app.whyYou || 'N/A'}</p><p><strong>Pourquoi nous ?</strong> ${app.whyUs || 'N/A'}</p>
                    <div class="application-actions">
                        <button class="action-btn approve-btn">Approuver</button><button class="action-btn deny-btn">Refuser</button>
                    </div>
                </div>`;
            card.querySelector('.application-header').addEventListener('click', () => card.classList.toggle('open'));
            card.querySelector('.approve-btn').addEventListener('click', (e) => handleDecision(e, app.userId, APP_STATUS.APPROVED, ROLES.MEMBER));
            card.querySelector('.deny-btn').addEventListener('click', (e) => handleDecision(e, app.userId, APP_STATUS.DENIED, ROLES.VISITOR));
            return card;
        }

        async function handleDecision(event, applicantId, newStatus, newRole) {
            event.stopPropagation();
            const button = event.target;
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            const originalText = newStatus === APP_STATUS.APPROVED ? 'Approuver' : 'Refuser';
            try {
                await updateDoc(doc(db, 'candidatures', applicantId), { status: newStatus });
                await updateDoc(doc(db, 'users', applicantId), { role: newRole });
                await loadAllApplications();
            } catch (error) {
                console.error("Erreur lors de la décision :", error);
                button.disabled = false;
                button.textContent = originalText;
            }
        }
    </script>
</body>
</html>