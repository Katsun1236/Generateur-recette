<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - Faction R4TIO</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .profile-container { max-width: 800px; margin: 2rem auto; padding: 2rem; background-color: var(--card-bg-color); border-radius: 10px; }
        .profile-header { display: flex; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid #444; padding-bottom: 2rem; gap: 2rem; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary-red); flex-shrink: 0; }
        .profile-info h1 { margin: 0; font-size: 2.5rem; font-family: 'Anton', sans-serif; word-break: break-all; }
        .profile-info p { margin: 5px 0 15px 0; color: var(--text-medium); font-weight: bold; text-transform: uppercase; }
        .profile-actions button { background-color: transparent; color: var(--text-light); border: 2px solid var(--primary-red); padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: all 0.3s; margin-right: 10px; }
        .profile-actions button:hover { background-color: var(--primary-red); }
        .logout-btn { background-color: var(--primary-red) !important; }
        .logout-btn:hover { background-color: var(--primary-red-dark) !important; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; }
        .stat-card { background-color: #2c2c2c; padding: 1.5rem; border-radius: 8px; text-align: center; }
        .stat-card i { font-size: 2rem; color: var(--primary-red); margin-bottom: 1rem; }
        .stat-card h3 { margin: 0 0 0.5rem 0; font-size: 1.5rem; word-break: break-all; }
        .stat-card p { margin: 0; color: var(--text-medium); font-size: 0.9rem; }
        .loading #username, .loading #user-role { background-color: #444; color: transparent; border-radius: 4px; min-height: 1em; animation: pulse-bg 1s infinite; }
        .discord-link-btn { background-color: var(--discord-blue); color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; display: inline-block; margin-top: 1rem; }
        .discord-linked { color: var(--green); font-weight: bold; }
        @keyframes pulse-bg { 50% { background-color: #555; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-left"><a href="../index.html"><img src="../images/pictures/Logo.png" alt="Logo R4TIO" class="nav-logo"></a></div>
        <div class="nav-center">
            <a href="https://discord.gg/UFVCDc4mkU" target="_blank" rel="noopener noreferrer">Discord</a>
            <a href="recrutement.html">Recrutement</a>
            <a href="market.html">Marché</a>
            <a href="orders.html" id="my-orders-link" style="display: none;">Mes Commandes</a>
            <a href="orders.html" id="orders-link" style="display: none; color: var(--yellow);">Commandes Staff</a>
            <a href="admin.html" id="admin-link" style="display: none; color: var(--yellow);">Administration</a>
        </div>
        <div class="nav-auth">
             <div id="auth-buttons" style="display: none;"><a href="login.html">Connexion</a><a href="register.html" class="register-btn">Inscription</a></div>
            <a href="profile.html" id="profile-link"><img id="profile-pic" src="" alt="Photo de profil"></a>
        </div>
    </nav>
    <div class="profile-container loading" id="profile-container">
        <div class="profile-header">
            <img src="" alt="Avatar de l'utilisateur" class="profile-avatar" id="avatar-img">
            <div class="profile-info">
                <h1 id="username">CHARGEMENT</h1>
                <p id="user-role">...</p>
                <div class="profile-actions">
                    <button id="edit-profile-btn"><i class="fas fa-pencil-alt"></i> Éditer</button>
                    <button id="logout-btn" class="logout-btn">Déconnexion</button>
                </div>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-card" id="discord-card">
                <i class="fa-brands fa-discord"></i>
                <div id="discord-content"></div>
                <p>Statut Discord</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-skull-crossbones"></i>
                <h3 id="user-kills">0</h3>
                <p>Kills (à venir)</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-cross"></i>
                <h3 id="user-deaths">0</h3>
                <p>Morts (à venir)</p>
            </div>
        </div>
    </div>
    <div id="message-box"></div>

    <!-- Le script principal s'occupe de la barre de navigation -->
    <script type="module" src="../js/main.js"></script>
    
    <!-- Le script de la page s'occupe du contenu de la page -->
    <script type="module">
        import { auth, db } from '../js/firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        const profileContainer = document.getElementById('profile-container');
        const usernameEl = document.getElementById('username');
        const userRoleEl = document.getElementById('user-role');
        const discordContentEl = document.getElementById('discord-content');
        const avatarImg = document.getElementById('avatar-img');
        const logoutBtn = document.getElementById('logout-btn');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        
        const functions = getFunctions("europe-west1");
        const discordClientId = "1407045715485786144";
        const redirectUri = "https://ratio-faction.netlify.app/pages/profile.html";
        const discordAuthUrl = `https://discord.com/api/oauth2/authorize?client_id=${discordClientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&scope=identify`;

        // Écouteur de connexion spécifique à cette page
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const params = new URLSearchParams(window.location.search);
                const discordCode = params.get('code');

                if (discordCode) {
                    document.body.innerHTML = '<h1>Liaison de votre compte Discord en cours...</h1>';
                    const linkDiscordAccount = httpsCallable(functions, 'linkDiscordAccount');
                    try {
                        await linkDiscordAccount({ code: discordCode, redirectUri: redirectUri });
                        window.location.href = 'profile.html';
                    } catch (error) {
                        document.body.innerHTML = `<h1>Erreur</h1><p>Impossible de lier votre compte Discord. Veuillez réessayer.</p><a href="profile.html">Retour au profil</a>`;
                    }
                    return;
                }

                const userDocRef = doc(db, 'users', user.uid);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists() && docSnap.data().onboardingComplete) {
                    const userData = docSnap.data();
                    usernameEl.textContent = userData.minecraftUsername || "Utilisateur";
                    userRoleEl.textContent = userData.role || 'Membre';
                    avatarImg.src = userData.avatar || `https://mc-heads.net/avatar/${userData.minecraftUsername}/120`;
                    
                    if (userData.discordId) {
                        discordContentEl.innerHTML = `<h3 class="discord-linked">Lié</h3><p style="margin:0;">${userData.discordUsername}</p>`;
                    } else {
                        discordContentEl.innerHTML = `<h3>Non lié</h3><a href="${discordAuthUrl}" class="discord-link-btn">Lier mon compte</a>`;
                    }
                    
                    profileContainer.classList.remove('loading');
                }
            }
        });

        // Les écouteurs d'événements pour les boutons sont ici
        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch(error => console.error("Logout Error:", error));
        });

        editProfileBtn.addEventListener('click', () => {
            alert("La fonctionnalité d'édition du profil sera bientôt disponible !");
        });
    </script>
</body>
</html>