<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi de Commande - Faction R4TIO</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body { background-color: #111; }
        .checkout-container { max-width: 800px; margin: 2rem auto; padding: 2rem; background-color: var(--card-bg-color); border-radius: 10px; border: 1px solid #333; }
        h1 { color: var(--primary-red); font-family: 'Anton', sans-serif; font-size: 2.5rem; text-align: center; margin-bottom: 0.5rem; }
        .subtitle { text-align: center; color: var(--text-medium); margin-bottom: 2rem; }
        .order-section { margin-bottom: 2rem; border-bottom: 1px solid #333; padding-bottom: 2rem; }
        .order-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        h2 { font-size: 1.5rem; color: var(--text-light); margin-bottom: 1rem; }
        .order-item { display: flex; align-items: center; padding: 1rem 0; border-bottom: 1px solid #333; }
        .order-item:last-child { border-bottom: none; }
        .order-item img { width: 50px; height: 50px; margin-right: 1rem; image-rendering: pixelated; background-color: #111; border-radius: 5px; }
        .order-item-details { flex-grow: 1; }
        .order-item-details strong { color: var(--text-light); }
        .order-total { text-align: right; font-size: 1.8rem; font-weight: bold; margin-top: 1rem; }
        .chat-box { max-height: 300px; overflow-y: auto; border: 1px solid #333; border-radius: 5px; padding: 1rem; margin-bottom: 1rem; background-color: #111; }
        .chat-message { margin-bottom: 1rem; }
        .chat-message p { margin: 0; word-break: break-word; }
        .chat-message .meta { font-size: 0.8rem; color: #888; margin-bottom: 0.25rem; }
        .chat-message .meta strong { color: var(--primary-red); }
        .chat-message.is-yours { text-align: right; }
        .chat-message.is-yours .meta strong { color: var(--discord-blue); }
        .chat-form { display: flex; gap: 1rem; }
        .chat-form input { flex-grow: 1; background-color: #333; border: 1px solid #555; border-radius: 5px; padding: 0.75rem; color: var(--text-light); }
        .chat-form button { background-color: var(--primary-red); color: white; border: none; border-radius: 5px; padding: 0.75rem 1rem; cursor: pointer; font-weight: bold; }
        .chat-form button:hover { background-color: var(--primary-red-dark); }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-left"><a href="../index.html"><img src="../images/pictures/Logo.png" alt="Logo R4TIO" class="nav-logo"></a></div>
        <div class="nav-center">
            <a href="https://discord.gg/UFVCDc4mkU" target="_blank" rel="noopener noreferrer">Discord</a>
            <a href="recrutement.html">Recrutement</a>
            <a href="market.html">Marché</a>
            <a href="admin.html" id="admin-link" style="display: none; color: var(--yellow);">Administration</a>
        </div>
        <div class="nav-auth">
             <div id="auth-buttons" style="display: none;"><a href="login.html">Connexion</a><a href="register.html" class="register-btn">Inscription</a></div>
            <a href="profile.html" id="profile-link"><img id="profile-pic" src="" alt="Photo de profil"></a>
        </div>
    </nav>
    <div class="checkout-container" id="checkout-container">
        <h1>Suivi de Commande</h1>
        <p class="subtitle" id="order-id-display"></p>
        <div class="order-section">
            <h2>Résumé de la commande</h2>
            <div id="order-items-summary"><p>Chargement...</p></div>
            <div class="order-total" id="order-total"></div>
        </div>
        <div class="order-section">
            <h2>Messages</h2>
            <div class="chat-box" id="chat-box"></div>
            <form class="chat-form" id="chat-form">
                <input type="text" id="chat-input" placeholder="Écrire un message..." required>
                <button type="submit">Envoyer</button>
            </form>
        </div>
    </div>
    <div id="message-box"></div>
    <script type="module" src="../js/main.js"></script>
    <script type="module">
        import { auth, db } from '../js/firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, getDoc, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const container = document.getElementById('checkout-container');
        const orderIdDisplay = document.getElementById('order-id-display');
        const orderItemsContainer = document.getElementById('order-items-summary');
        const orderTotalElement = document.getElementById('order-total');
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        let currentUser = null;
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadOrderDetails();
            } else {
                window.location.href = 'login.html';
            }
        });
        async function loadOrderDetails() {
            const params = new URLSearchParams(window.location.search);
            const orderId = params.get('orderId');
            if (!orderId) { container.innerHTML = "<h1>Erreur</h1><p>Aucun ID de commande fourni.</p>"; return; }
            orderIdDisplay.textContent = `ID de la commande : ${orderId}`;
            try {
                const orderDocRef = doc(db, 'orders', orderId);
                const orderDocSnap = await getDoc(orderDocRef);
                if (!orderDocSnap.exists()) { container.innerHTML = "<h1>Erreur</h1><p>Commande introuvable.</p>"; return; }
                const orderData = orderDocSnap.data();
                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDocSnap = await getDoc(userDocRef);
                const userRole = userDocSnap.exists() ? userDocSnap.data().role : null;
                const isOwner = orderData.clientId === currentUser.uid;
                // **CORRECTION ICI** : On vérifie si l'utilisateur a un des rôles du marché
                const isMarketStaff = ['Admin', 'Leader', 'Officier', 'Vendeur'].includes(userRole);
                if (!isOwner && !isMarketStaff) {
                    container.innerHTML = "<h1>Accès non autorisé</h1><p>Vous n'avez pas la permission de voir cette commande.</p>";
                    return;
                }
                orderItemsContainer.innerHTML = '';
                orderData.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'order-item';
                    itemElement.innerHTML = `
                        <img src="${item.img}" alt="${item.name}">
                        <div class="order-item-details"><p><strong>${item.name}</strong> (x${item.quantity})</p></div>
                        <p><strong>${(item.quantity * item.buyPrice).toLocaleString('fr-FR')}$</strong></p>`;
                    orderItemsContainer.appendChild(itemElement);
                });
                orderTotalElement.textContent = `Total : ${orderData.totalPrice.toLocaleString('fr-FR')}$`;
                setupChat(orderId);
            } catch (error) {
                console.error("Error fetching order:", error);
                container.innerHTML = "<h1>Erreur</h1><p>Impossible de charger les détails de la commande.</p>";
            }
        }
        function setupChat(orderId) {
            const messagesRef = collection(db, 'orders', orderId, 'messages');
            const q = query(messagesRef, orderBy('timestamp'));
            onSnapshot(q, (snapshot) => {
                chatBox.innerHTML = '';
                if (snapshot.empty) { chatBox.innerHTML = `<p style="text-align: center; color: #888;">Commencez la conversation !</p>`; }
                snapshot.forEach(doc => {
                    const message = doc.data();
                    const messageEl = document.createElement('div');
                    messageEl.className = 'chat-message';
                    if (message.senderId === currentUser.uid) { messageEl.classList.add('is-yours'); }
                    const sentAt = message.timestamp?.toDate().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) || '';
                    messageEl.innerHTML = `
                        <div class="meta"><strong>${message.senderUsername}</strong> - ${sentAt}</div>
                        <p>${message.text}</p>`;
                    chatBox.appendChild(messageEl);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = chatInput.value.trim();
                if (text && currentUser) {
                    const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    const username = userDoc.data()?.minecraftUsername || 'Utilisateur';
                    chatInput.disabled = true;
                    try {
                        await addDoc(messagesRef, {
                            text: text, senderId: currentUser.uid, senderUsername: username, timestamp: serverTimestamp()
                        });
                        chatInput.value = '';
                    } catch (error) { console.error("Error sending message:", error); }
                    finally { chatInput.disabled = false; chatInput.focus(); }
                }
            });
        }
    </script>
</body>
</html>